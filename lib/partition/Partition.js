var CameraNode = require("awayjs-display/lib/partition/CameraNode");
var DirectionalLightNode = require("awayjs-display/lib/partition/DirectionalLightNode");
var EntityNode = require("awayjs-display/lib/partition/EntityNode");
var LightProbeNode = require("awayjs-display/lib/partition/LightProbeNode");
var PointLightNode = require("awayjs-display/lib/partition/PointLightNode");
var SkyboxNode = require("awayjs-display/lib/partition/SkyboxNode");
var NullNode = require("awayjs-display/lib/partition/NullNode");
var EntityNodePool = require("awayjs-display/lib/pool/EntityNodePool");
/**
 * @class away.partition.Partition
 */
var Partition = (function () {
    function Partition(rootNode) {
        this._updatesMade = false;
        this._rootNode = rootNode || new NullNode();
        this._cameraNodePool = new EntityNodePool(CameraNode, this);
        this._directionalLightNodePool = new EntityNodePool(DirectionalLightNode, this);
        this._entityNodePool = new EntityNodePool(EntityNode, this);
        this._lightProbeNodePool = new EntityNodePool(LightProbeNode, this);
        this._pointLightNodePool = new EntityNodePool(PointLightNode, this);
        this._skyboxNodePool = new EntityNodePool(SkyboxNode, this);
    }
    Object.defineProperty(Partition.prototype, "rootNode", {
        get: function () {
            return this._rootNode;
        },
        enumerable: true,
        configurable: true
    });
    Partition.prototype.traverse = function (traverser) {
        if (this._updatesMade)
            this.updateEntities();
        this._rootNode.acceptTraverser(traverser);
    };
    Partition.prototype.iMarkForUpdate = function (node) {
        var t = this._updateQueue;
        while (t) {
            if (node == t)
                return;
            t = t._iUpdateQueueNext;
        }
        node._iUpdateQueueNext = this._updateQueue;
        this._updateQueue = node;
        this._updatesMade = true;
    };
    Partition.prototype.iRemoveEntity = function (node) {
        var t;
        node.removeFromParent();
        if (node == this._updateQueue) {
            this._updateQueue = node._iUpdateQueueNext;
        }
        else {
            t = this._updateQueue;
            while (t && t._iUpdateQueueNext != node)
                t = t._iUpdateQueueNext;
            if (t)
                t._iUpdateQueueNext = node._iUpdateQueueNext;
        }
        node._iUpdateQueueNext = null;
        if (!this._updateQueue)
            this._updatesMade = false;
    };
    Partition.prototype.updateEntities = function () {
        var node = this._updateQueue;
        var targetNode;
        var t;
        this._updateQueue = null;
        this._updatesMade = false;
        do {
            targetNode = this._rootNode.findPartitionForEntity(node.entity);
            if (node.parent != targetNode) {
                if (node)
                    node.removeFromParent();
                targetNode.iAddNode(node);
            }
            t = node._iUpdateQueueNext;
            node._iUpdateQueueNext = null;
            //required for controllers with autoUpdate set to true
            node.entity._iInternalUpdate();
        } while ((node = t) != null);
    };
    /**
     * @internal
     */
    Partition.prototype._iRegisterCamera = function (camera) {
        this.iMarkForUpdate(this._cameraNodePool.getItem(camera));
    };
    /**
     * @internal
     */
    Partition.prototype._iRegisterDirectionalLight = function (directionalLight) {
        this.iMarkForUpdate(this._directionalLightNodePool.getItem(directionalLight));
    };
    /**
     * @internal
     */
    Partition.prototype._iRegisterEntity = function (entity) {
        this.iMarkForUpdate(this._entityNodePool.getItem(entity));
    };
    /**
     * @internal
     */
    Partition.prototype._iRegisterLightProbe = function (lightProbe) {
        this.iMarkForUpdate(this._lightProbeNodePool.getItem(lightProbe));
    };
    /**
     * @internal
     */
    Partition.prototype._iRegisterPointLight = function (pointLight) {
        this.iMarkForUpdate(this._pointLightNodePool.getItem(pointLight));
    };
    /**
     * @internal
     */
    Partition.prototype._iRegisterSkybox = function (skybox) {
        this.iMarkForUpdate(this._skyboxNodePool.getItem(skybox));
    };
    /**
     * @internal
     */
    Partition.prototype._iUnregisterCamera = function (camera) {
        this.iRemoveEntity(this._cameraNodePool.disposeItem(camera));
    };
    /**
     * @internal
     */
    Partition.prototype._iUnregisterDirectionalLight = function (directionalLight) {
        this.iRemoveEntity(this._directionalLightNodePool.disposeItem(directionalLight));
    };
    /**
     * @internal
     */
    Partition.prototype._iUnregisterEntity = function (entity) {
        this.iRemoveEntity(this._entityNodePool.disposeItem(entity));
    };
    /**
     * @internal
     */
    Partition.prototype._iUnregisterLightProbe = function (lightProbe) {
        this.iRemoveEntity(this._lightProbeNodePool.disposeItem(lightProbe));
    };
    /**
     * @internal
     */
    Partition.prototype._iUnregisterPointLight = function (pointLight) {
        this.iRemoveEntity(this._pointLightNodePool.disposeItem(pointLight));
    };
    /**
     * @internal
     */
    Partition.prototype._iUnregisterSkybox = function (skybox) {
        this.iRemoveEntity(this._skyboxNodePool.disposeItem(skybox));
    };
    return Partition;
})();
module.exports = Partition;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1kaXNwbGF5L2xpYi9wYXJ0aXRpb24vUGFydGl0aW9uLnRzIl0sIm5hbWVzIjpbIlBhcnRpdGlvbiIsIlBhcnRpdGlvbi5jb25zdHJ1Y3RvciIsIlBhcnRpdGlvbi5yb290Tm9kZSIsIlBhcnRpdGlvbi50cmF2ZXJzZSIsIlBhcnRpdGlvbi5pTWFya0ZvclVwZGF0ZSIsIlBhcnRpdGlvbi5pUmVtb3ZlRW50aXR5IiwiUGFydGl0aW9uLnVwZGF0ZUVudGl0aWVzIiwiUGFydGl0aW9uLl9pUmVnaXN0ZXJDYW1lcmEiLCJQYXJ0aXRpb24uX2lSZWdpc3RlckRpcmVjdGlvbmFsTGlnaHQiLCJQYXJ0aXRpb24uX2lSZWdpc3RlckVudGl0eSIsIlBhcnRpdGlvbi5faVJlZ2lzdGVyTGlnaHRQcm9iZSIsIlBhcnRpdGlvbi5faVJlZ2lzdGVyUG9pbnRMaWdodCIsIlBhcnRpdGlvbi5faVJlZ2lzdGVyU2t5Ym94IiwiUGFydGl0aW9uLl9pVW5yZWdpc3RlckNhbWVyYSIsIlBhcnRpdGlvbi5faVVucmVnaXN0ZXJEaXJlY3Rpb25hbExpZ2h0IiwiUGFydGl0aW9uLl9pVW5yZWdpc3RlckVudGl0eSIsIlBhcnRpdGlvbi5faVVucmVnaXN0ZXJMaWdodFByb2JlIiwiUGFydGl0aW9uLl9pVW5yZWdpc3RlclBvaW50TGlnaHQiLCJQYXJ0aXRpb24uX2lVbnJlZ2lzdGVyU2t5Ym94Il0sIm1hcHBpbmdzIjoiQUFNQSxJQUFPLFVBQVUsV0FBZSx5Q0FBeUMsQ0FBQyxDQUFDO0FBQzNFLElBQU8sb0JBQW9CLFdBQWEsbURBQW1ELENBQUMsQ0FBQztBQUM3RixJQUFPLFVBQVUsV0FBZSx5Q0FBeUMsQ0FBQyxDQUFDO0FBQzNFLElBQU8sY0FBYyxXQUFjLDZDQUE2QyxDQUFDLENBQUM7QUFDbEYsSUFBTyxjQUFjLFdBQWMsNkNBQTZDLENBQUMsQ0FBQztBQUNsRixJQUFPLFVBQVUsV0FBZSx5Q0FBeUMsQ0FBQyxDQUFDO0FBRTNFLElBQU8sUUFBUSxXQUFnQix1Q0FB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Q0E7SUFFRGpCOztPQUVHQTtJQUNJQSxzQ0FBa0JBLEdBQXpCQSxVQUEwQkEsTUFBYUE7UUFFdENrQixJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxXQUFXQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUM5REEsQ0FBQ0E7SUFDRmxCLGdCQUFDQTtBQUFEQSxDQXpNQSxBQXlNQ0EsSUFBQTtBQUVELEFBQW1CLGlCQUFWLFNBQVMsQ0FBQyIsImZpbGUiOiJwYXJ0aXRpb24vUGFydGl0aW9uLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDYW1lcmFcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xyXG5pbXBvcnQgRGlyZWN0aW9uYWxMaWdodFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0RpcmVjdGlvbmFsTGlnaHRcIik7XHJcbmltcG9ydCBJRW50aXR5XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0lFbnRpdHlcIik7XHJcbmltcG9ydCBMaWdodFByb2JlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9MaWdodFByb2JlXCIpO1xyXG5pbXBvcnQgUG9pbnRMaWdodFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvUG9pbnRMaWdodFwiKTtcclxuaW1wb3J0IFNreWJveFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9Ta3lib3hcIik7XHJcbmltcG9ydCBDYW1lcmFOb2RlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9wYXJ0aXRpb24vQ2FtZXJhTm9kZVwiKTtcclxuaW1wb3J0IERpcmVjdGlvbmFsTGlnaHROb2RlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL3BhcnRpdGlvbi9EaXJlY3Rpb25hbExpZ2h0Tm9kZVwiKTtcclxuaW1wb3J0IEVudGl0eU5vZGVcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL3BhcnRpdGlvbi9FbnRpdHlOb2RlXCIpO1xyXG5pbXBvcnQgTGlnaHRQcm9iZU5vZGVcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9wYXJ0aXRpb24vTGlnaHRQcm9iZU5vZGVcIik7XHJcbmltcG9ydCBQb2ludExpZ2h0Tm9kZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL3BhcnRpdGlvbi9Qb2ludExpZ2h0Tm9kZVwiKTtcclxuaW1wb3J0IFNreWJveE5vZGVcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL3BhcnRpdGlvbi9Ta3lib3hOb2RlXCIpO1xyXG5pbXBvcnQgTm9kZUJhc2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvcGFydGl0aW9uL05vZGVCYXNlXCIpO1xyXG5pbXBvcnQgTnVsbE5vZGVcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvcGFydGl0aW9uL051bGxOb2RlXCIpO1xyXG5pbXBvcnQgRW50aXR5Tm9kZVBvb2xcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9wb29sL0VudGl0eU5vZGVQb29sXCIpO1xyXG5pbXBvcnQgQ29sbGVjdG9yQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL3RyYXZlcnNlL0NvbGxlY3RvckJhc2VcIik7XHJcblxyXG4vKipcclxuICogQGNsYXNzIGF3YXkucGFydGl0aW9uLlBhcnRpdGlvblxyXG4gKi9cclxuY2xhc3MgUGFydGl0aW9uXHJcbntcclxuXHRwcml2YXRlIF9jYW1lcmFOb2RlUG9vbDpFbnRpdHlOb2RlUG9vbDtcclxuXHRwcml2YXRlIF9kaXJlY3Rpb25hbExpZ2h0Tm9kZVBvb2w6RW50aXR5Tm9kZVBvb2w7XHJcblx0cHJpdmF0ZSBfZW50aXR5Tm9kZVBvb2w6RW50aXR5Tm9kZVBvb2w7XHJcblx0cHJpdmF0ZSBfbGlnaHRQcm9iZU5vZGVQb29sOkVudGl0eU5vZGVQb29sO1xyXG5cdHByaXZhdGUgX3BvaW50TGlnaHROb2RlUG9vbDpFbnRpdHlOb2RlUG9vbDtcclxuXHRwcml2YXRlIF9za3lib3hOb2RlUG9vbDpFbnRpdHlOb2RlUG9vbDtcclxuXHJcblx0cHVibGljIF9yb290Tm9kZTpOb2RlQmFzZTtcclxuXHRwcml2YXRlIF91cGRhdGVzTWFkZTpCb29sZWFuID0gZmFsc2U7XHJcblx0cHJpdmF0ZSBfdXBkYXRlUXVldWU6RW50aXR5Tm9kZTtcclxuXHJcblx0Y29uc3RydWN0b3Iocm9vdE5vZGU6Tm9kZUJhc2UpXHJcblx0e1xyXG5cdFx0dGhpcy5fcm9vdE5vZGUgPSByb290Tm9kZSB8fCA8Tm9kZUJhc2U+IG5ldyBOdWxsTm9kZSgpO1xyXG5cclxuXHRcdHRoaXMuX2NhbWVyYU5vZGVQb29sID0gbmV3IEVudGl0eU5vZGVQb29sKENhbWVyYU5vZGUsIHRoaXMpO1xyXG5cdFx0dGhpcy5fZGlyZWN0aW9uYWxMaWdodE5vZGVQb29sID0gbmV3IEVudGl0eU5vZGVQb29sKERpcmVjdGlvbmFsTGlnaHROb2RlLCB0aGlzKTtcclxuXHRcdHRoaXMuX2VudGl0eU5vZGVQb29sID0gbmV3IEVudGl0eU5vZGVQb29sKEVudGl0eU5vZGUsIHRoaXMpO1xyXG5cdFx0dGhpcy5fbGlnaHRQcm9iZU5vZGVQb29sID0gbmV3IEVudGl0eU5vZGVQb29sKExpZ2h0UHJvYmVOb2RlLCB0aGlzKTtcclxuXHRcdHRoaXMuX3BvaW50TGlnaHROb2RlUG9vbCA9IG5ldyBFbnRpdHlOb2RlUG9vbChQb2ludExpZ2h0Tm9kZSwgdGhpcyk7XHJcblx0XHR0aGlzLl9za3lib3hOb2RlUG9vbCA9IG5ldyBFbnRpdHlOb2RlUG9vbChTa3lib3hOb2RlLCB0aGlzKTtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBnZXQgcm9vdE5vZGUoKTpOb2RlQmFzZVxyXG5cdHtcclxuXHRcdHJldHVybiB0aGlzLl9yb290Tm9kZTtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyB0cmF2ZXJzZSh0cmF2ZXJzZXI6Q29sbGVjdG9yQmFzZSlcclxuXHR7XHJcblx0XHRpZiAodGhpcy5fdXBkYXRlc01hZGUpXHJcblx0XHRcdHRoaXMudXBkYXRlRW50aXRpZXMoKTtcclxuXHJcblx0XHR0aGlzLl9yb290Tm9kZS5hY2NlcHRUcmF2ZXJzZXIodHJhdmVyc2VyKTtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBpTWFya0ZvclVwZGF0ZShub2RlOkVudGl0eU5vZGUpXHJcblx0e1xyXG5cdFx0dmFyIHQ6RW50aXR5Tm9kZSA9IHRoaXMuX3VwZGF0ZVF1ZXVlO1xyXG5cclxuXHRcdHdoaWxlICh0KSB7XHJcblx0XHRcdGlmIChub2RlID09IHQpXHJcblx0XHRcdFx0cmV0dXJuO1xyXG5cclxuXHRcdFx0dCA9IHQuX2lVcGRhdGVRdWV1ZU5leHQ7XHJcblx0XHR9XHJcblxyXG5cdFx0bm9kZS5faVVwZGF0ZVF1ZXVlTmV4dCA9IHRoaXMuX3VwZGF0ZVF1ZXVlO1xyXG5cclxuXHRcdHRoaXMuX3VwZGF0ZVF1ZXVlID0gbm9kZTtcclxuXHRcdHRoaXMuX3VwZGF0ZXNNYWRlID0gdHJ1ZTtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBpUmVtb3ZlRW50aXR5KG5vZGU6RW50aXR5Tm9kZSlcclxuXHR7XHJcblx0XHR2YXIgdDpFbnRpdHlOb2RlO1xyXG5cclxuXHRcdG5vZGUucmVtb3ZlRnJvbVBhcmVudCgpO1xyXG5cclxuXHRcdGlmIChub2RlID09IHRoaXMuX3VwZGF0ZVF1ZXVlKSB7XHJcblx0XHRcdHRoaXMuX3VwZGF0ZVF1ZXVlID0gbm9kZS5faVVwZGF0ZVF1ZXVlTmV4dDtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHQgPSB0aGlzLl91cGRhdGVRdWV1ZTtcclxuXHRcdFx0d2hpbGUgKHQgJiYgdC5faVVwZGF0ZVF1ZXVlTmV4dCAhPSBub2RlKVxyXG5cdFx0XHRcdHQgPSB0Ll9pVXBkYXRlUXVldWVOZXh0O1xyXG5cclxuXHRcdFx0aWYgKHQpXHJcblx0XHRcdFx0dC5faVVwZGF0ZVF1ZXVlTmV4dCA9IG5vZGUuX2lVcGRhdGVRdWV1ZU5leHQ7XHJcblx0XHR9XHJcblxyXG5cdFx0bm9kZS5faVVwZGF0ZVF1ZXVlTmV4dCA9IG51bGw7XHJcblxyXG5cdFx0aWYgKCF0aGlzLl91cGRhdGVRdWV1ZSlcclxuXHRcdFx0dGhpcy5fdXBkYXRlc01hZGUgPSBmYWxzZTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgdXBkYXRlRW50aXRpZXMoKVxyXG5cdHtcclxuXHRcdHZhciBub2RlOkVudGl0eU5vZGUgPSB0aGlzLl91cGRhdGVRdWV1ZTtcclxuXHRcdHZhciB0YXJnZXROb2RlOk5vZGVCYXNlO1xyXG5cdFx0dmFyIHQ6RW50aXR5Tm9kZTtcclxuXHRcdHRoaXMuX3VwZGF0ZVF1ZXVlID0gbnVsbDtcclxuXHRcdHRoaXMuX3VwZGF0ZXNNYWRlID0gZmFsc2U7XHJcblxyXG5cdFx0ZG8ge1xyXG5cdFx0XHR0YXJnZXROb2RlID0gdGhpcy5fcm9vdE5vZGUuZmluZFBhcnRpdGlvbkZvckVudGl0eShub2RlLmVudGl0eSk7XHJcblxyXG5cdFx0XHRpZiAobm9kZS5wYXJlbnQgIT0gdGFyZ2V0Tm9kZSkge1xyXG5cdFx0XHRcdGlmIChub2RlKVxyXG5cdFx0XHRcdFx0bm9kZS5yZW1vdmVGcm9tUGFyZW50KCk7XHJcblxyXG5cdFx0XHRcdHRhcmdldE5vZGUuaUFkZE5vZGUobm9kZSk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdHQgPSBub2RlLl9pVXBkYXRlUXVldWVOZXh0O1xyXG5cdFx0XHRub2RlLl9pVXBkYXRlUXVldWVOZXh0ID0gbnVsbDtcclxuXHJcblx0XHRcdC8vcmVxdWlyZWQgZm9yIGNvbnRyb2xsZXJzIHdpdGggYXV0b1VwZGF0ZSBzZXQgdG8gdHJ1ZVxyXG5cdFx0XHRub2RlLmVudGl0eS5faUludGVybmFsVXBkYXRlKCk7XHJcblxyXG5cdFx0fSB3aGlsZSAoKG5vZGUgPSB0KSAhPSBudWxsKTtcclxuXHR9XHJcblxyXG5cclxuXHQvKipcclxuXHQgKiBAaW50ZXJuYWxcclxuXHQgKi9cclxuXHRwdWJsaWMgX2lSZWdpc3RlckNhbWVyYShjYW1lcmE6Q2FtZXJhKVxyXG5cdHtcclxuXHRcdHRoaXMuaU1hcmtGb3JVcGRhdGUodGhpcy5fY2FtZXJhTm9kZVBvb2wuZ2V0SXRlbShjYW1lcmEpKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbnRlcm5hbFxyXG5cdCAqL1xyXG5cdHB1YmxpYyBfaVJlZ2lzdGVyRGlyZWN0aW9uYWxMaWdodChkaXJlY3Rpb25hbExpZ2h0OkRpcmVjdGlvbmFsTGlnaHQpXHJcblx0e1xyXG5cdFx0dGhpcy5pTWFya0ZvclVwZGF0ZSh0aGlzLl9kaXJlY3Rpb25hbExpZ2h0Tm9kZVBvb2wuZ2V0SXRlbShkaXJlY3Rpb25hbExpZ2h0KSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW50ZXJuYWxcclxuXHQgKi9cclxuXHRwdWJsaWMgX2lSZWdpc3RlckVudGl0eShlbnRpdHk6SUVudGl0eSlcclxuXHR7XHJcblx0XHR0aGlzLmlNYXJrRm9yVXBkYXRlKHRoaXMuX2VudGl0eU5vZGVQb29sLmdldEl0ZW0oZW50aXR5KSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW50ZXJuYWxcclxuXHQgKi9cclxuXHRwdWJsaWMgX2lSZWdpc3RlckxpZ2h0UHJvYmUobGlnaHRQcm9iZTpMaWdodFByb2JlKVxyXG5cdHtcclxuXHRcdHRoaXMuaU1hcmtGb3JVcGRhdGUodGhpcy5fbGlnaHRQcm9iZU5vZGVQb29sLmdldEl0ZW0obGlnaHRQcm9iZSkpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGludGVybmFsXHJcblx0ICovXHJcblx0cHVibGljIF9pUmVnaXN0ZXJQb2ludExpZ2h0KHBvaW50TGlnaHQ6UG9pbnRMaWdodClcclxuXHR7XHJcblx0XHR0aGlzLmlNYXJrRm9yVXBkYXRlKHRoaXMuX3BvaW50TGlnaHROb2RlUG9vbC5nZXRJdGVtKHBvaW50TGlnaHQpKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbnRlcm5hbFxyXG5cdCAqL1xyXG5cdHB1YmxpYyBfaVJlZ2lzdGVyU2t5Ym94KHNreWJveDpTa3lib3gpXHJcblx0e1xyXG5cdFx0dGhpcy5pTWFya0ZvclVwZGF0ZSh0aGlzLl9za3lib3hOb2RlUG9vbC5nZXRJdGVtKHNreWJveCkpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGludGVybmFsXHJcblx0ICovXHJcblx0cHVibGljIF9pVW5yZWdpc3RlckNhbWVyYShjYW1lcmE6Q2FtZXJhKVxyXG5cdHtcclxuXHRcdHRoaXMuaVJlbW92ZUVudGl0eSh0aGlzLl9jYW1lcmFOb2RlUG9vbC5kaXNwb3NlSXRlbShjYW1lcmEpKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbnRlcm5hbFxyXG5cdCAqL1xyXG5cdHB1YmxpYyBfaVVucmVnaXN0ZXJEaXJlY3Rpb25hbExpZ2h0KGRpcmVjdGlvbmFsTGlnaHQ6RGlyZWN0aW9uYWxMaWdodClcclxuXHR7XHJcblx0XHR0aGlzLmlSZW1vdmVFbnRpdHkodGhpcy5fZGlyZWN0aW9uYWxMaWdodE5vZGVQb29sLmRpc3Bvc2VJdGVtKGRpcmVjdGlvbmFsTGlnaHQpKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbnRlcm5hbFxyXG5cdCAqL1xyXG5cdHB1YmxpYyBfaVVucmVnaXN0ZXJFbnRpdHkoZW50aXR5OklFbnRpdHkpXHJcblx0e1xyXG5cdFx0dGhpcy5pUmVtb3ZlRW50aXR5KHRoaXMuX2VudGl0eU5vZGVQb29sLmRpc3Bvc2VJdGVtKGVudGl0eSkpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGludGVybmFsXHJcblx0ICovXHJcblx0cHVibGljIF9pVW5yZWdpc3RlckxpZ2h0UHJvYmUobGlnaHRQcm9iZTpMaWdodFByb2JlKVxyXG5cdHtcclxuXHRcdHRoaXMuaVJlbW92ZUVudGl0eSh0aGlzLl9saWdodFByb2JlTm9kZVBvb2wuZGlzcG9zZUl0ZW0obGlnaHRQcm9iZSkpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGludGVybmFsXHJcblx0ICovXHJcblx0cHVibGljIF9pVW5yZWdpc3RlclBvaW50TGlnaHQocG9pbnRMaWdodDpQb2ludExpZ2h0KVxyXG5cdHtcclxuXHRcdHRoaXMuaVJlbW92ZUVudGl0eSh0aGlzLl9wb2ludExpZ2h0Tm9kZVBvb2wuZGlzcG9zZUl0ZW0ocG9pbnRMaWdodCkpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGludGVybmFsXHJcblx0ICovXHJcblx0cHVibGljIF9pVW5yZWdpc3RlclNreWJveChza3lib3g6U2t5Ym94KVxyXG5cdHtcclxuXHRcdHRoaXMuaVJlbW92ZUVudGl0eSh0aGlzLl9za3lib3hOb2RlUG9vbC5kaXNwb3NlSXRlbShza3lib3gpKTtcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCA9IFBhcnRpdGlvbjsiXX0=