var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Event = require("awayjs-core/lib/events/Event");
var DirectionalLight = require("awayjs-display/lib/entities/DirectionalLight");
var LightProbe = require("awayjs-display/lib/entities/LightProbe");
var PointLight = require("awayjs-display/lib/entities/PointLight");
var LightEvent = require("awayjs-display/lib/events/LightEvent");
var LightPickerBase = require("awayjs-display/lib/materials/lightpickers/LightPickerBase");
/**
 * StaticLightPicker is a light picker that provides a static set of lights. The lights can be reassigned, but
 * if the configuration changes (number of directional lights, point lights, etc), a material recompilation may
 * occur.
 */
var StaticLightPicker = (function (_super) {
    __extends(StaticLightPicker, _super);
    /**
     * Creates a new StaticLightPicker object.
     * @param lights The lights to be used for shading.
     */
    function StaticLightPicker(lights) {
        var _this = this;
        _super.call(this);
        this._onCastShadowChangeDelegate = function (event) { return _this.onCastShadowChange(event); };
        this.lights = lights;
    }
    Object.defineProperty(StaticLightPicker.prototype, "lights", {
        /**
         * The lights used for shading.
         */
        get: function () {
            return this._lights;
        },
        set: function (value) {
            var numPointLights = 0;
            var numDirectionalLights = 0;
            var numCastingPointLights = 0;
            var numCastingDirectionalLights = 0;
            var numLightProbes = 0;
            var light;
            if (this._lights)
                this.clearListeners();
            this._lights = value;
            this._pAllPickedLights = value;
            this._pPointLights = new Array();
            this._pCastingPointLights = new Array();
            this._pDirectionalLights = new Array();
            this._pCastingDirectionalLights = new Array();
            this._pLightProbes = new Array();
            var len = value.length;
            for (var i = 0; i < len; ++i) {
                light = value[i];
                light.addEventListener(LightEvent.CASTS_SHADOW_CHANGE, this._onCastShadowChangeDelegate);
                if (light instanceof PointLight) {
                    if (light.castsShadows)
                        this._pCastingPointLights[numCastingPointLights++] = light;
                    else
                        this._pPointLights[numPointLights++] = light;
                }
                else if (light instanceof DirectionalLight) {
                    if (light.castsShadows)
                        this._pCastingDirectionalLights[numCastingDirectionalLights++] = light;
                    else
                        this._pDirectionalLights[numDirectionalLights++] = light;
                }
                else if (light instanceof LightProbe) {
                    this._pLightProbes[numLightProbes++] = light;
                }
            }
            if (this._pNumDirectionalLights == numDirectionalLights && this._pNumPointLights == numPointLights && this._pNumLightProbes == numLightProbes && this._pNumCastingPointLights == numCastingPointLights && this._pNumCastingDirectionalLights == numCastingDirectionalLights)
                return;
            this._pNumDirectionalLights = numDirectionalLights;
            this._pNumCastingDirectionalLights = numCastingDirectionalLights;
            this._pNumPointLights = numPointLights;
            this._pNumCastingPointLights = numCastingPointLights;
            this._pNumLightProbes = numLightProbes;
            // MUST HAVE MULTIPLE OF 4 ELEMENTS!
            this._pLightProbeWeights = new Array(Math.ceil(numLightProbes / 4) * 4);
            // notify material lights have changed
            this.dispatchEvent(new Event(Event.CHANGE));
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Remove configuration change listeners on the lights.
     */
    StaticLightPicker.prototype.clearListeners = function () {
        var len = this._lights.length;
        for (var i = 0; i < len; ++i)
            this._lights[i].removeEventListener(LightEvent.CASTS_SHADOW_CHANGE, this._onCastShadowChangeDelegate);
    };
    /**
     * Notifies the material of a configuration change.
     */
    StaticLightPicker.prototype.onCastShadowChange = function (event) {
        // TODO: Assign to special caster collections, just append it to the lights in SinglePass
        // But keep seperated in multipass
        var light = event.target;
        if (light instanceof PointLight)
            this.updatePointCasting(light);
        else if (light instanceof DirectionalLight)
            this.updateDirectionalCasting(light);
        this.dispatchEvent(new Event(Event.CHANGE));
    };
    /**
     * Called when a directional light's shadow casting configuration changes.
     */
    StaticLightPicker.prototype.updateDirectionalCasting = function (light) {
        var dl = light;
        if (light.castsShadows) {
            --this._pNumDirectionalLights;
            ++this._pNumCastingDirectionalLights;
            this._pDirectionalLights.splice(this._pDirectionalLights.indexOf(dl), 1);
            this._pCastingDirectionalLights.push(light);
        }
        else {
            ++this._pNumDirectionalLights;
            --this._pNumCastingDirectionalLights;
            this._pCastingDirectionalLights.splice(this._pCastingDirectionalLights.indexOf(dl), 1);
            this._pDirectionalLights.push(light);
        }
    };
    /**
     * Called when a point light's shadow casting configuration changes.
     */
    StaticLightPicker.prototype.updatePointCasting = function (light) {
        var pl = light;
        if (light.castsShadows) {
            --this._pNumPointLights;
            ++this._pNumCastingPointLights;
            this._pPointLights.splice(this._pPointLights.indexOf(pl), 1);
            this._pCastingPointLights.push(light);
        }
        else {
            ++this._pNumPointLights;
            --this._pNumCastingPointLights;
            this._pCastingPointLights.splice(this._pCastingPointLights.indexOf(pl), 1);
            this._pPointLights.push(light);
        }
    };
    return StaticLightPicker;
})(LightPickerBase);
module.exports = StaticLightPicker;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1kaXNwbGF5L2xpYi9tYXRlcmlhbHMvbGlnaHRwaWNrZXJzL1N0YXRpY0xpZ2h0UGlja2VyLnRzIl0sIm5hbWVzIjpbIlN0YXRpY0xpZ2h0UGlja2VyIiwiU3RhdGljTGlnaHRQaWNrZXIuY29uc3RydWN0b3IiLCJTdGF0aWNMaWdodFBpY2tlci5saWdodHMiLCJTdGF0aWNMaWdodFBpY2tlci5jbGVhckxpc3RlbmVycyIsIlN0YXRpY0xpZ2h0UGlja2VyLm9uQ2FzdFNoYWRvd0NoYW5nZSIsIlN0YXRpY0xpZ2h0UGlja2VyLnVwZGF0ZURpcmVjdGlvbmFsQ2FzdGluZyIsIlN0YXRpY0xpZ2h0UGlja2VyLnVwZGF0ZVBvaW50Q2FzdGluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTyxLQUFLLFdBQWdCLDhCQUE4QixDQUFDLENBQUM7QUFHNUQsSUFBTyxnQkFBZ0IsV0FBYyw4Q0FBOEMsQ0FBQyxDQUFDO0FBQ3JGLElBQU8sVUFBVSxXQUFlLHdDQUF3QyxDQUFDLENBQUM7QUFDMUUsSUFBTyxVQUFVLFdBQWUsd0NBQXdDLENBQUMsQ0FBQztBQUMxRSxJQUFPLFVBQVUsV0FBZSxzQ0FBc0MsQ0FBQyxDQUFDO0FBQ3hFLElBQU8sZUFBZSxXQUFjLDJEQUEyRCxDQUFDLENBQUM7QUFFakcsQUFLQTs7OztHQURHO0lBQ0csaUJBQWlCO0lBQVNBLFVBQTFCQSxpQkFBaUJBLFVBQXdCQTtJQUs5Q0E7OztPQUdHQTtJQUNIQSxTQVRLQSxpQkFBaUJBLENBU1ZBLE1BQU1BO1FBVG5CQyxpQkE4SkNBO1FBbkpDQSxpQkFBT0EsQ0FBQ0E7UUFFUkEsSUFBSUEsQ0FBQ0EsMkJBQTJCQSxHQUFHQSxVQUFDQSxLQUFnQkEsSUFBS0EsT0FBQUEsS0FBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxLQUFLQSxDQUFDQSxFQUE5QkEsQ0FBOEJBLENBQUNBO1FBRXhGQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxNQUFNQSxDQUFDQTtJQUN0QkEsQ0FBQ0E7SUFL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Q0EsQ0FBQ0E7WUFDUEEsRUFBRUEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQTtZQUN4QkEsRUFBRUEsSUFBSUEsQ0FBQ0EsdUJBQXVCQSxDQUFDQTtZQUUvQkEsSUFBSUEsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxvQkFBb0JBLENBQUNBLE9BQU9BLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBQzNFQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUNoQ0EsQ0FBQ0E7SUFDRkEsQ0FBQ0E7SUFDRk4sd0JBQUNBO0FBQURBLENBOUpBLEFBOEpDQSxFQTlKK0IsZUFBZSxFQThKOUM7QUFFRCxBQUEyQixpQkFBbEIsaUJBQWlCLENBQUMiLCJmaWxlIjoibWF0ZXJpYWxzL2xpZ2h0cGlja2Vycy9TdGF0aWNMaWdodFBpY2tlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRXZlbnRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZXZlbnRzL0V2ZW50XCIpO1xyXG5cclxuaW1wb3J0IExpZ2h0QmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvYmFzZS9MaWdodEJhc2VcIik7XHJcbmltcG9ydCBEaXJlY3Rpb25hbExpZ2h0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvRGlyZWN0aW9uYWxMaWdodFwiKTtcclxuaW1wb3J0IExpZ2h0UHJvYmVcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0xpZ2h0UHJvYmVcIik7XHJcbmltcG9ydCBQb2ludExpZ2h0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9Qb2ludExpZ2h0XCIpO1xyXG5pbXBvcnQgTGlnaHRFdmVudFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZXZlbnRzL0xpZ2h0RXZlbnRcIik7XHJcbmltcG9ydCBMaWdodFBpY2tlckJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9tYXRlcmlhbHMvbGlnaHRwaWNrZXJzL0xpZ2h0UGlja2VyQmFzZVwiKTtcclxuXHJcbi8qKlxyXG4gKiBTdGF0aWNMaWdodFBpY2tlciBpcyBhIGxpZ2h0IHBpY2tlciB0aGF0IHByb3ZpZGVzIGEgc3RhdGljIHNldCBvZiBsaWdodHMuIFRoZSBsaWdodHMgY2FuIGJlIHJlYXNzaWduZWQsIGJ1dFxyXG4gKiBpZiB0aGUgY29uZmlndXJhdGlvbiBjaGFuZ2VzIChudW1iZXIgb2YgZGlyZWN0aW9uYWwgbGlnaHRzLCBwb2ludCBsaWdodHMsIGV0YyksIGEgbWF0ZXJpYWwgcmVjb21waWxhdGlvbiBtYXlcclxuICogb2NjdXIuXHJcbiAqL1xyXG5jbGFzcyBTdGF0aWNMaWdodFBpY2tlciBleHRlbmRzIExpZ2h0UGlja2VyQmFzZVxyXG57XHJcblx0cHJpdmF0ZSBfbGlnaHRzOkFycmF5PGFueT47XHJcblx0cHJpdmF0ZSBfb25DYXN0U2hhZG93Q2hhbmdlRGVsZWdhdGU6RnVuY3Rpb247XHJcblxyXG5cdC8qKlxyXG5cdCAqIENyZWF0ZXMgYSBuZXcgU3RhdGljTGlnaHRQaWNrZXIgb2JqZWN0LlxyXG5cdCAqIEBwYXJhbSBsaWdodHMgVGhlIGxpZ2h0cyB0byBiZSB1c2VkIGZvciBzaGFkaW5nLlxyXG5cdCAqL1xyXG5cdGNvbnN0cnVjdG9yKGxpZ2h0cylcclxuXHR7XHJcblx0XHRzdXBlcigpO1xyXG5cclxuXHRcdHRoaXMuX29uQ2FzdFNoYWRvd0NoYW5nZURlbGVnYXRlID0gKGV2ZW50OkxpZ2h0RXZlbnQpID0+IHRoaXMub25DYXN0U2hhZG93Q2hhbmdlKGV2ZW50KTtcclxuXHJcblx0XHR0aGlzLmxpZ2h0cyA9IGxpZ2h0cztcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIFRoZSBsaWdodHMgdXNlZCBmb3Igc2hhZGluZy5cclxuXHQgKi9cclxuXHRwdWJsaWMgZ2V0IGxpZ2h0cygpXHJcblx0e1xyXG5cdFx0cmV0dXJuIHRoaXMuX2xpZ2h0cztcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBzZXQgbGlnaHRzKHZhbHVlOkFycmF5PGFueT4pXHJcblx0e1xyXG5cdFx0dmFyIG51bVBvaW50TGlnaHRzOm51bWJlciA9IDA7XHJcblx0XHR2YXIgbnVtRGlyZWN0aW9uYWxMaWdodHM6bnVtYmVyID0gMDtcclxuXHRcdHZhciBudW1DYXN0aW5nUG9pbnRMaWdodHM6bnVtYmVyID0gMDtcclxuXHRcdHZhciBudW1DYXN0aW5nRGlyZWN0aW9uYWxMaWdodHM6bnVtYmVyID0gMDtcclxuXHRcdHZhciBudW1MaWdodFByb2JlczpudW1iZXIgPSAwO1xyXG5cdFx0dmFyIGxpZ2h0OkxpZ2h0QmFzZTtcclxuXHJcblx0XHRpZiAodGhpcy5fbGlnaHRzKVxyXG5cdFx0XHR0aGlzLmNsZWFyTGlzdGVuZXJzKCk7XHJcblxyXG5cdFx0dGhpcy5fbGlnaHRzID0gdmFsdWU7XHJcblx0XHR0aGlzLl9wQWxsUGlja2VkTGlnaHRzID0gdmFsdWU7XHJcblx0XHR0aGlzLl9wUG9pbnRMaWdodHMgPSBuZXcgQXJyYXk8UG9pbnRMaWdodD4oKTtcclxuXHRcdHRoaXMuX3BDYXN0aW5nUG9pbnRMaWdodHMgPSBuZXcgQXJyYXk8UG9pbnRMaWdodD4oKTtcclxuXHRcdHRoaXMuX3BEaXJlY3Rpb25hbExpZ2h0cyA9IG5ldyBBcnJheTxEaXJlY3Rpb25hbExpZ2h0PigpO1xyXG5cdFx0dGhpcy5fcENhc3RpbmdEaXJlY3Rpb25hbExpZ2h0cyA9IG5ldyBBcnJheTxEaXJlY3Rpb25hbExpZ2h0PigpO1xyXG5cdFx0dGhpcy5fcExpZ2h0UHJvYmVzID0gbmV3IEFycmF5PExpZ2h0UHJvYmU+KCk7XHJcblxyXG5cdFx0dmFyIGxlbjpudW1iZXIgPSB2YWx1ZS5sZW5ndGg7XHJcblxyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgbGVuOyArK2kpIHtcclxuXHRcdFx0bGlnaHQgPSB2YWx1ZVtpXTtcclxuXHRcdFx0bGlnaHQuYWRkRXZlbnRMaXN0ZW5lcihMaWdodEV2ZW50LkNBU1RTX1NIQURPV19DSEFOR0UsIHRoaXMuX29uQ2FzdFNoYWRvd0NoYW5nZURlbGVnYXRlKTtcclxuXHJcblx0XHRcdGlmIChsaWdodCBpbnN0YW5jZW9mIFBvaW50TGlnaHQpIHtcclxuXHRcdFx0XHRpZiAobGlnaHQuY2FzdHNTaGFkb3dzKVxyXG5cdFx0XHRcdFx0dGhpcy5fcENhc3RpbmdQb2ludExpZ2h0c1tudW1DYXN0aW5nUG9pbnRMaWdodHMrK10gPSA8UG9pbnRMaWdodD4gbGlnaHQ7XHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0dGhpcy5fcFBvaW50TGlnaHRzW251bVBvaW50TGlnaHRzKytdID0gPFBvaW50TGlnaHQ+IGxpZ2h0O1xyXG5cclxuXHRcdFx0fSBlbHNlIGlmIChsaWdodCBpbnN0YW5jZW9mIERpcmVjdGlvbmFsTGlnaHQpIHtcclxuXHRcdFx0XHRpZiAobGlnaHQuY2FzdHNTaGFkb3dzKVxyXG5cdFx0XHRcdFx0dGhpcy5fcENhc3RpbmdEaXJlY3Rpb25hbExpZ2h0c1tudW1DYXN0aW5nRGlyZWN0aW9uYWxMaWdodHMrK10gPSA8RGlyZWN0aW9uYWxMaWdodD4gbGlnaHQ7XHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0dGhpcy5fcERpcmVjdGlvbmFsTGlnaHRzW251bURpcmVjdGlvbmFsTGlnaHRzKytdID0gPERpcmVjdGlvbmFsTGlnaHQ+IGxpZ2h0O1xyXG5cclxuXHRcdFx0fSBlbHNlIGlmIChsaWdodCBpbnN0YW5jZW9mIExpZ2h0UHJvYmUpIHtcclxuXHRcdFx0XHR0aGlzLl9wTGlnaHRQcm9iZXNbbnVtTGlnaHRQcm9iZXMrK10gPSA8TGlnaHRQcm9iZT4gbGlnaHQ7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHRpZiAodGhpcy5fcE51bURpcmVjdGlvbmFsTGlnaHRzID09IG51bURpcmVjdGlvbmFsTGlnaHRzICYmIHRoaXMuX3BOdW1Qb2ludExpZ2h0cyA9PSBudW1Qb2ludExpZ2h0cyAmJiB0aGlzLl9wTnVtTGlnaHRQcm9iZXMgPT0gbnVtTGlnaHRQcm9iZXMgJiYgdGhpcy5fcE51bUNhc3RpbmdQb2ludExpZ2h0cyA9PSBudW1DYXN0aW5nUG9pbnRMaWdodHMgJiYgdGhpcy5fcE51bUNhc3RpbmdEaXJlY3Rpb25hbExpZ2h0cyA9PSBudW1DYXN0aW5nRGlyZWN0aW9uYWxMaWdodHMpXHJcblx0XHRcdHJldHVybjtcclxuXHJcblx0XHR0aGlzLl9wTnVtRGlyZWN0aW9uYWxMaWdodHMgPSBudW1EaXJlY3Rpb25hbExpZ2h0cztcclxuXHRcdHRoaXMuX3BOdW1DYXN0aW5nRGlyZWN0aW9uYWxMaWdodHMgPSBudW1DYXN0aW5nRGlyZWN0aW9uYWxMaWdodHM7XHJcblx0XHR0aGlzLl9wTnVtUG9pbnRMaWdodHMgPSBudW1Qb2ludExpZ2h0cztcclxuXHRcdHRoaXMuX3BOdW1DYXN0aW5nUG9pbnRMaWdodHMgPSBudW1DYXN0aW5nUG9pbnRMaWdodHM7XHJcblx0XHR0aGlzLl9wTnVtTGlnaHRQcm9iZXMgPSBudW1MaWdodFByb2JlcztcclxuXHJcblx0XHQvLyBNVVNUIEhBVkUgTVVMVElQTEUgT0YgNCBFTEVNRU5UUyFcclxuXHRcdHRoaXMuX3BMaWdodFByb2JlV2VpZ2h0cyA9IG5ldyBBcnJheTxudW1iZXI+KE1hdGguY2VpbChudW1MaWdodFByb2Jlcy80KSo0KTtcclxuXHJcblx0XHQvLyBub3RpZnkgbWF0ZXJpYWwgbGlnaHRzIGhhdmUgY2hhbmdlZFxyXG5cdFx0dGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudChFdmVudC5DSEFOR0UpKTtcclxuXHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBSZW1vdmUgY29uZmlndXJhdGlvbiBjaGFuZ2UgbGlzdGVuZXJzIG9uIHRoZSBsaWdodHMuXHJcblx0ICovXHJcblx0cHJpdmF0ZSBjbGVhckxpc3RlbmVycygpXHJcblx0e1xyXG5cdFx0dmFyIGxlbjpudW1iZXIgPSB0aGlzLl9saWdodHMubGVuZ3RoO1xyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgbGVuOyArK2kpXHJcblx0XHRcdHRoaXMuX2xpZ2h0c1tpXS5yZW1vdmVFdmVudExpc3RlbmVyKExpZ2h0RXZlbnQuQ0FTVFNfU0hBRE9XX0NIQU5HRSwgdGhpcy5fb25DYXN0U2hhZG93Q2hhbmdlRGVsZWdhdGUpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogTm90aWZpZXMgdGhlIG1hdGVyaWFsIG9mIGEgY29uZmlndXJhdGlvbiBjaGFuZ2UuXHJcblx0ICovXHJcblx0cHJpdmF0ZSBvbkNhc3RTaGFkb3dDaGFuZ2UoZXZlbnQ6TGlnaHRFdmVudClcclxuXHR7XHJcblx0XHQvLyBUT0RPOiBBc3NpZ24gdG8gc3BlY2lhbCBjYXN0ZXIgY29sbGVjdGlvbnMsIGp1c3QgYXBwZW5kIGl0IHRvIHRoZSBsaWdodHMgaW4gU2luZ2xlUGFzc1xyXG5cdFx0Ly8gQnV0IGtlZXAgc2VwZXJhdGVkIGluIG11bHRpcGFzc1xyXG5cclxuXHRcdHZhciBsaWdodDpMaWdodEJhc2UgPSA8TGlnaHRCYXNlPiBldmVudC50YXJnZXQ7XHJcblxyXG5cdFx0aWYgKGxpZ2h0IGluc3RhbmNlb2YgUG9pbnRMaWdodClcclxuXHRcdFx0dGhpcy51cGRhdGVQb2ludENhc3RpbmcoPFBvaW50TGlnaHQ+IGxpZ2h0KTtcclxuXHRcdGVsc2UgaWYgKGxpZ2h0IGluc3RhbmNlb2YgRGlyZWN0aW9uYWxMaWdodClcclxuXHRcdFx0dGhpcy51cGRhdGVEaXJlY3Rpb25hbENhc3RpbmcoPERpcmVjdGlvbmFsTGlnaHQ+IGxpZ2h0KTtcclxuXHJcblx0XHR0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KEV2ZW50LkNIQU5HRSkpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQ2FsbGVkIHdoZW4gYSBkaXJlY3Rpb25hbCBsaWdodCdzIHNoYWRvdyBjYXN0aW5nIGNvbmZpZ3VyYXRpb24gY2hhbmdlcy5cclxuXHQgKi9cclxuXHRwcml2YXRlIHVwZGF0ZURpcmVjdGlvbmFsQ2FzdGluZyhsaWdodDpEaXJlY3Rpb25hbExpZ2h0KVxyXG5cdHtcclxuXHRcdHZhciBkbDpEaXJlY3Rpb25hbExpZ2h0ID0gPERpcmVjdGlvbmFsTGlnaHQ+IGxpZ2h0O1xyXG5cclxuXHRcdGlmIChsaWdodC5jYXN0c1NoYWRvd3MpIHtcclxuXHRcdFx0LS10aGlzLl9wTnVtRGlyZWN0aW9uYWxMaWdodHM7XHJcblx0XHRcdCsrdGhpcy5fcE51bUNhc3RpbmdEaXJlY3Rpb25hbExpZ2h0cztcclxuXHJcblxyXG5cdFx0XHR0aGlzLl9wRGlyZWN0aW9uYWxMaWdodHMuc3BsaWNlKHRoaXMuX3BEaXJlY3Rpb25hbExpZ2h0cy5pbmRleE9mKGRsKSwgMSk7XHJcblx0XHRcdHRoaXMuX3BDYXN0aW5nRGlyZWN0aW9uYWxMaWdodHMucHVzaChsaWdodCk7XHJcblxyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0Kyt0aGlzLl9wTnVtRGlyZWN0aW9uYWxMaWdodHM7XHJcblx0XHRcdC0tdGhpcy5fcE51bUNhc3RpbmdEaXJlY3Rpb25hbExpZ2h0cztcclxuXHJcblx0XHRcdHRoaXMuX3BDYXN0aW5nRGlyZWN0aW9uYWxMaWdodHMuc3BsaWNlKHRoaXMuX3BDYXN0aW5nRGlyZWN0aW9uYWxMaWdodHMuaW5kZXhPZihkbCksIDEpO1xyXG5cdFx0XHR0aGlzLl9wRGlyZWN0aW9uYWxMaWdodHMucHVzaChsaWdodCk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBDYWxsZWQgd2hlbiBhIHBvaW50IGxpZ2h0J3Mgc2hhZG93IGNhc3RpbmcgY29uZmlndXJhdGlvbiBjaGFuZ2VzLlxyXG5cdCAqL1xyXG5cdHByaXZhdGUgdXBkYXRlUG9pbnRDYXN0aW5nKGxpZ2h0OlBvaW50TGlnaHQpXHJcblx0e1xyXG5cdFx0dmFyIHBsOlBvaW50TGlnaHQgPSA8UG9pbnRMaWdodD4gbGlnaHQ7XHJcblxyXG5cdFx0aWYgKGxpZ2h0LmNhc3RzU2hhZG93cykge1xyXG5cdFx0XHQtLXRoaXMuX3BOdW1Qb2ludExpZ2h0cztcclxuXHRcdFx0Kyt0aGlzLl9wTnVtQ2FzdGluZ1BvaW50TGlnaHRzO1xyXG5cdFx0XHR0aGlzLl9wUG9pbnRMaWdodHMuc3BsaWNlKHRoaXMuX3BQb2ludExpZ2h0cy5pbmRleE9mKHBsKSwgMSk7XHJcblx0XHRcdHRoaXMuX3BDYXN0aW5nUG9pbnRMaWdodHMucHVzaChsaWdodCk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHQrK3RoaXMuX3BOdW1Qb2ludExpZ2h0cztcclxuXHRcdFx0LS10aGlzLl9wTnVtQ2FzdGluZ1BvaW50TGlnaHRzO1xyXG5cclxuXHRcdFx0dGhpcy5fcENhc3RpbmdQb2ludExpZ2h0cy5zcGxpY2UodGhpcy5fcENhc3RpbmdQb2ludExpZ2h0cy5pbmRleE9mKHBsKSwgMSk7XHJcblx0XHRcdHRoaXMuX3BQb2ludExpZ2h0cy5wdXNoKGxpZ2h0KTtcclxuXHRcdH1cclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCA9IFN0YXRpY0xpZ2h0UGlja2VyOyJdfQ==