var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3D = require("awayjs-core/lib/geom/Matrix3D");
var FreeMatrixProjection = require("awayjs-core/lib/projections/FreeMatrixProjection");
var Camera = require("awayjs-display/lib/entities/Camera");
var ShadowMapperBase = require("awayjs-display/lib/materials/shadowmappers/ShadowMapperBase");
var DirectionalShadowMapper = (function (_super) {
    __extends(DirectionalShadowMapper, _super);
    function DirectionalShadowMapper() {
        _super.call(this);
        this._pLightOffset = 10000;
        this._pSnap = 64;
        this._pCullPlanes = [];
        this._pOverallDepthProjection = new FreeMatrixProjection();
        this._pOverallDepthCamera = new Camera(this._pOverallDepthProjection);
        this._pLocalFrustum = [];
        this._pMatrix = new Matrix3D();
    }
    Object.defineProperty(DirectionalShadowMapper.prototype, "snap", {
        get: function () {
            return this._pSnap;
        },
        set: function (value) {
            this._pSnap = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DirectionalShadowMapper.prototype, "lightOffset", {
        get: function () {
            return this._pLightOffset;
        },
        set: function (value) {
            this._pLightOffset = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DirectionalShadowMapper.prototype, "iDepthProjection", {
        //@arcane
        get: function () {
            return this._pOverallDepthCamera.viewProjection;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DirectionalShadowMapper.prototype, "depth", {
        //@arcane
        get: function () {
            return this._pMaxZ - this._pMinZ;
        },
        enumerable: true,
        configurable: true
    });
    //@override
    DirectionalShadowMapper.prototype.pDrawDepthMap = function (target, scene, renderer) {
        this._pCasterCollector.camera = this._pOverallDepthCamera;
        this._pCasterCollector.cullPlanes = this._pCullPlanes;
        this._pCasterCollector.clear();
        scene.traversePartitions(this._pCasterCollector);
        renderer._iRender(this._pCasterCollector, target);
    };
    //@protected
    DirectionalShadowMapper.prototype.pUpdateCullPlanes = function (viewCamera) {
        var lightFrustumPlanes = this._pOverallDepthCamera.frustumPlanes;
        var viewFrustumPlanes = viewCamera.frustumPlanes;
        this._pCullPlanes.length = 4;
        this._pCullPlanes[0] = lightFrustumPlanes[0];
        this._pCullPlanes[1] = lightFrustumPlanes[1];
        this._pCullPlanes[2] = lightFrustumPlanes[2];
        this._pCullPlanes[3] = lightFrustumPlanes[3];
        var light = this._pLight;
        var dir = light.sceneDirection;
        var dirX = dir.x;
        var dirY = dir.y;
        var dirZ = dir.z;
        var j = 4;
        for (var i = 0; i < 6; ++i) {
            var plane = viewFrustumPlanes[i];
            if (plane.a * dirX + plane.b * dirY + plane.c * dirZ < 0)
                this._pCullPlanes[j++] = plane;
        }
    };
    //@override
    DirectionalShadowMapper.prototype.pUpdateDepthProjection = function (viewCamera) {
        this.pUpdateProjectionFromFrustumCorners(viewCamera, viewCamera.projection.frustumCorners, this._pMatrix);
        this._pOverallDepthProjection.matrix = this._pMatrix;
        this.pUpdateCullPlanes(viewCamera);
    };
    DirectionalShadowMapper.prototype.pUpdateProjectionFromFrustumCorners = function (viewCamera, corners, matrix) {
        var raw = new Array();
        var dir;
        var x, y, z;
        var minX, minY;
        var maxX, maxY;
        var i;
        var light = this._pLight;
        dir = light.sceneDirection;
        this._pOverallDepthCamera.transform.matrix3D = this._pLight.sceneTransform;
        x = Math.floor((viewCamera.x - dir.x * this._pLightOffset) / this._pSnap) * this._pSnap;
        y = Math.floor((viewCamera.y - dir.y * this._pLightOffset) / this._pSnap) * this._pSnap;
        z = Math.floor((viewCamera.z - dir.z * this._pLightOffset) / this._pSnap) * this._pSnap;
        this._pOverallDepthCamera.x = x;
        this._pOverallDepthCamera.y = y;
        this._pOverallDepthCamera.z = z;
        this._pMatrix.copyFrom(this._pOverallDepthCamera.inverseSceneTransform);
        this._pMatrix.prepend(viewCamera.sceneTransform);
        this._pMatrix.transformVectors(corners, this._pLocalFrustum);
        minX = maxX = this._pLocalFrustum[0];
        minY = maxY = this._pLocalFrustum[1];
        this._pMaxZ = this._pLocalFrustum[2];
        i = 3;
        while (i < 24) {
            x = this._pLocalFrustum[i];
            y = this._pLocalFrustum[i + 1];
            z = this._pLocalFrustum[i + 2];
            if (x < minX)
                minX = x;
            if (x > maxX)
                maxX = x;
            if (y < minY)
                minY = y;
            if (y > maxY)
                maxY = y;
            if (z > this._pMaxZ)
                this._pMaxZ = z;
            i += 3;
        }
        this._pMinZ = 1;
        var w = maxX - minX;
        var h = maxY - minY;
        var d = 1 / (this._pMaxZ - this._pMinZ);
        if (minX < 0)
            minX -= this._pSnap; // because int() rounds up for < 0
        if (minY < 0)
            minY -= this._pSnap;
        minX = Math.floor(minX / this._pSnap) * this._pSnap;
        minY = Math.floor(minY / this._pSnap) * this._pSnap;
        var snap2 = 2 * this._pSnap;
        w = Math.floor(w / snap2 + 2) * snap2;
        h = Math.floor(h / snap2 + 2) * snap2;
        maxX = minX + w;
        maxY = minY + h;
        w = 1 / w;
        h = 1 / h;
        raw[0] = 2 * w;
        raw[5] = 2 * h;
        raw[10] = d;
        raw[12] = -(maxX + minX) * w;
        raw[13] = -(maxY + minY) * h;
        raw[14] = -this._pMinZ * d;
        raw[15] = 1;
        raw[1] = raw[2] = raw[3] = raw[4] = raw[6] = raw[7] = raw[8] = raw[9] = raw[11] = 0;
        matrix.copyRawDataFrom(raw);
    };
    return DirectionalShadowMapper;
})(ShadowMapperBase);
module.exports = DirectionalShadowMapper;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1kaXNwbGF5L2xpYi9tYXRlcmlhbHMvc2hhZG93bWFwcGVycy9EaXJlY3Rpb25hbFNoYWRvd01hcHBlci50cyJdLCJuYW1lcyI6WyJEaXJlY3Rpb25hbFNoYWRvd01hcHBlciIsIkRpcmVjdGlvbmFsU2hhZG93TWFwcGVyLmNvbnN0cnVjdG9yIiwiRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIuc25hcCIsIkRpcmVjdGlvbmFsU2hhZG93TWFwcGVyLmxpZ2h0T2Zmc2V0IiwiRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIuaURlcHRoUHJvamVjdGlvbiIsIkRpcmVjdGlvbmFsU2hhZG93TWFwcGVyLmRlcHRoIiwiRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIucERyYXdEZXB0aE1hcCIsIkRpcmVjdGlvbmFsU2hhZG93TWFwcGVyLnBVcGRhdGVDdWxsUGxhbmVzIiwiRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXIucFVwZGF0ZURlcHRoUHJvamVjdGlvbiIsIkRpcmVjdGlvbmFsU2hhZG93TWFwcGVyLnBVcGRhdGVQcm9qZWN0aW9uRnJvbUZydXN0dW1Db3JuZXJzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFPLFFBQVEsV0FBZ0IsK0JBQStCLENBQUMsQ0FBQztBQUdoRSxJQUFPLG9CQUFvQixXQUFhLGtEQUFrRCxDQUFDLENBQUM7QUFJNUYsSUFBTyxNQUFNLFdBQWdCLG9DQUFvQyxDQUFDLENBQUM7QUFFbkUsSUFBTyxnQkFBZ0IsV0FBYyw2REFBNkQsQ0FBQyxDQUFDO0FBSXBHLElBQU0sdUJBQXVCO0lBQVNBLFVBQWhDQSx1QkFBdUJBLFVBQXlCQTtJQWNyREEsU0FkS0EsdUJBQXVCQTtRQWdCM0JDLGlCQUFPQSxDQUFDQTtRQVhGQSxrQkFBYUEsR0FBVUEsS0FBS0EsQ0FBQ0E7UUFHN0JBLFdBQU1BLEdBQVVBLEVBQUVBLENBQUNBO1FBVXpCQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSxFQUFFQSxDQUFDQTtRQUN2QkEsSUFBSUEsQ0FBQ0Esd0JB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QUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMzQkEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDL0JBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1lBQy9CQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDWkEsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDVkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0E7Z0JBQ1pBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBO1lBQ1ZBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO2dCQUNaQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNWQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDWkEsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDVkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7Z0JBQ25CQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNqQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDUkEsQ0FBQ0E7UUFFREEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFFaEJBLElBQUlBLENBQUNBLEdBQVVBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBO1FBQzNCQSxJQUFJQSxDQUFDQSxHQUFVQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUMzQkEsSUFBSUEsQ0FBQ0EsR0FBVUEsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFFN0NBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBO1lBQ1pBLElBQUlBLElBQUlBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLGtDQUFrQ0E7UUFFeERBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBO1lBQ1pBLElBQUlBLElBQUlBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBO1FBRXJCQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxHQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUNoREEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsR0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFFaERBLElBQUlBLEtBQUtBLEdBQVVBLENBQUNBLEdBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBO1FBQ2pDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxHQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFDQSxLQUFLQSxDQUFDQTtRQUNsQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsS0FBS0EsQ0FBQ0E7UUFFbENBLElBQUlBLEdBQUdBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBO1FBQ2hCQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUVoQkEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDUkEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFUkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDYkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDYkEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDWkEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0JBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLEdBQUNBLENBQUNBLENBQUNBO1FBQzNCQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFDQSxDQUFDQSxDQUFDQTtRQUN6QkEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDWkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFFcEZBLE1BQU1BLENBQUNBLGVBQWVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO0lBQzdCQSxDQUFDQTtJQUNGVCw4QkFBQ0E7QUFBREEsQ0FyTEEsQUFxTENBLEVBckxxQyxnQkFBZ0IsRUFxTHJEO0FBRUQsQUFBaUMsaUJBQXhCLHVCQUF1QixDQUFDIiwiZmlsZSI6Im1hdGVyaWFscy9zaGFkb3dtYXBwZXJzL0RpcmVjdGlvbmFsU2hhZG93TWFwcGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBNYXRyaXgzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL01hdHJpeDNEXCIpO1xyXG5pbXBvcnQgUGxhbmUzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL1BsYW5lM0RcIik7XHJcbmltcG9ydCBWZWN0b3IzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL1ZlY3RvcjNEXCIpO1xyXG5pbXBvcnQgRnJlZU1hdHJpeFByb2plY3Rpb25cdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvcHJvamVjdGlvbnMvRnJlZU1hdHJpeFByb2plY3Rpb25cIik7XHJcblxyXG5pbXBvcnQgU2NlbmVcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvY29udGFpbmVycy9TY2VuZVwiKTtcclxuaW1wb3J0IElSZW5kZXJlclx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvcmVuZGVyL0lSZW5kZXJlclwiKTtcclxuaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XHJcbmltcG9ydCBEaXJlY3Rpb25hbExpZ2h0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvRGlyZWN0aW9uYWxMaWdodFwiKTtcclxuaW1wb3J0IFNoYWRvd01hcHBlckJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9tYXRlcmlhbHMvc2hhZG93bWFwcGVycy9TaGFkb3dNYXBwZXJCYXNlXCIpO1xyXG5pbXBvcnQgUmVuZGVyVGV4dHVyZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3RleHR1cmVzL1JlbmRlclRleHR1cmVcIik7XHJcbmltcG9ydCBUZXh0dXJlQmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvVGV4dHVyZUJhc2VcIik7XHJcblxyXG5jbGFzcyBEaXJlY3Rpb25hbFNoYWRvd01hcHBlciBleHRlbmRzIFNoYWRvd01hcHBlckJhc2Vcclxue1xyXG5cdHB1YmxpYyBfcE92ZXJhbGxEZXB0aENhbWVyYTpDYW1lcmE7XHJcblx0cHVibGljIF9wTG9jYWxGcnVzdHVtOkFycmF5PG51bWJlcj47XHJcblxyXG5cdHB1YmxpYyBfcExpZ2h0T2Zmc2V0Om51bWJlciA9IDEwMDAwO1xyXG5cdHB1YmxpYyBfcE1hdHJpeDpNYXRyaXgzRDtcclxuXHRwdWJsaWMgX3BPdmVyYWxsRGVwdGhQcm9qZWN0aW9uOkZyZWVNYXRyaXhQcm9qZWN0aW9uO1xyXG5cdHB1YmxpYyBfcFNuYXA6bnVtYmVyID0gNjQ7XHJcblxyXG5cdHB1YmxpYyBfcEN1bGxQbGFuZXM6QXJyYXk8UGxhbmUzRD47XHJcblx0cHVibGljIF9wTWluWjpudW1iZXI7XHJcblx0cHVibGljIF9wTWF4WjpudW1iZXI7XHJcblxyXG5cdGNvbnN0cnVjdG9yKClcclxuXHR7XHJcblx0XHRzdXBlcigpO1xyXG5cclxuXHRcdHRoaXMuX3BDdWxsUGxhbmVzID0gW107XHJcblx0XHR0aGlzLl9wT3ZlcmFsbERlcHRoUHJvamVjdGlvbiA9IG5ldyBGcmVlTWF0cml4UHJvamVjdGlvbigpO1xyXG5cdFx0dGhpcy5fcE92ZXJhbGxEZXB0aENhbWVyYSA9IG5ldyBDYW1lcmEodGhpcy5fcE92ZXJhbGxEZXB0aFByb2plY3Rpb24pO1xyXG5cdFx0dGhpcy5fcExvY2FsRnJ1c3R1bSA9IFtdO1xyXG5cdFx0dGhpcy5fcE1hdHJpeCA9IG5ldyBNYXRyaXgzRCgpO1xyXG5cdH1cclxuXHJcblx0cHVibGljIGdldCBzbmFwKCk6bnVtYmVyXHJcblx0e1xyXG5cdFx0cmV0dXJuIHRoaXMuX3BTbmFwO1xyXG5cdH1cclxuXHJcblx0cHVibGljIHNldCBzbmFwKHZhbHVlOm51bWJlcilcclxuXHR7XHJcblx0XHR0aGlzLl9wU25hcCA9IHZhbHVlO1xyXG5cdH1cclxuXHJcblx0cHVibGljIGdldCBsaWdodE9mZnNldCgpOm51bWJlclxyXG5cdHtcclxuXHRcdHJldHVybiB0aGlzLl9wTGlnaHRPZmZzZXQ7XHJcblx0fVxyXG5cclxuXHRwdWJsaWMgc2V0IGxpZ2h0T2Zmc2V0KHZhbHVlOm51bWJlcilcclxuXHR7XHJcblx0XHR0aGlzLl9wTGlnaHRPZmZzZXQgPSB2YWx1ZTtcclxuXHR9XHJcblxyXG5cdC8vQGFyY2FuZVxyXG5cdHB1YmxpYyBnZXQgaURlcHRoUHJvamVjdGlvbigpOk1hdHJpeDNEXHJcblx0e1xyXG5cdFx0cmV0dXJuIHRoaXMuX3BPdmVyYWxsRGVwdGhDYW1lcmEudmlld1Byb2plY3Rpb247XHJcblx0fVxyXG5cclxuXHQvL0BhcmNhbmVcclxuXHRwdWJsaWMgZ2V0IGRlcHRoKCk6bnVtYmVyXHJcblx0e1xyXG5cdFx0cmV0dXJuIHRoaXMuX3BNYXhaIC0gdGhpcy5fcE1pblo7XHJcblx0fVxyXG5cclxuXHQvL0BvdmVycmlkZVxyXG5cdHB1YmxpYyBwRHJhd0RlcHRoTWFwKHRhcmdldDpUZXh0dXJlQmFzZSwgc2NlbmU6U2NlbmUsIHJlbmRlcmVyOklSZW5kZXJlcilcclxuXHR7XHJcblx0XHR0aGlzLl9wQ2FzdGVyQ29sbGVjdG9yLmNhbWVyYSA9IHRoaXMuX3BPdmVyYWxsRGVwdGhDYW1lcmE7XHJcblx0XHR0aGlzLl9wQ2FzdGVyQ29sbGVjdG9yLmN1bGxQbGFuZXMgPSB0aGlzLl9wQ3VsbFBsYW5lcztcclxuXHRcdHRoaXMuX3BDYXN0ZXJDb2xsZWN0b3IuY2xlYXIoKTtcclxuXHRcdHNjZW5lLnRyYXZlcnNlUGFydGl0aW9ucyh0aGlzLl9wQ2FzdGVyQ29sbGVjdG9yKTtcclxuXHRcdHJlbmRlcmVyLl9pUmVuZGVyKHRoaXMuX3BDYXN0ZXJDb2xsZWN0b3IsIHRhcmdldCk7XHJcblx0fVxyXG5cclxuXHQvL0Bwcm90ZWN0ZWRcclxuXHRwdWJsaWMgcFVwZGF0ZUN1bGxQbGFuZXModmlld0NhbWVyYTpDYW1lcmEpXHJcblx0e1xyXG5cdFx0dmFyIGxpZ2h0RnJ1c3R1bVBsYW5lczpBcnJheTxQbGFuZTNEPiA9IHRoaXMuX3BPdmVyYWxsRGVwdGhDYW1lcmEuZnJ1c3R1bVBsYW5lcztcclxuXHRcdHZhciB2aWV3RnJ1c3R1bVBsYW5lczpBcnJheTxQbGFuZTNEPiA9IHZpZXdDYW1lcmEuZnJ1c3R1bVBsYW5lcztcclxuXHRcdHRoaXMuX3BDdWxsUGxhbmVzLmxlbmd0aCA9IDQ7XHJcblxyXG5cdFx0dGhpcy5fcEN1bGxQbGFuZXNbMF0gPSBsaWdodEZydXN0dW1QbGFuZXNbMF07XHJcblx0XHR0aGlzLl9wQ3VsbFBsYW5lc1sxXSA9IGxpZ2h0RnJ1c3R1bVBsYW5lc1sxXTtcclxuXHRcdHRoaXMuX3BDdWxsUGxhbmVzWzJdID0gbGlnaHRGcnVzdHVtUGxhbmVzWzJdO1xyXG5cdFx0dGhpcy5fcEN1bGxQbGFuZXNbM10gPSBsaWdodEZydXN0dW1QbGFuZXNbM107XHJcblxyXG5cdFx0dmFyIGxpZ2h0OkRpcmVjdGlvbmFsTGlnaHQgPSA8RGlyZWN0aW9uYWxMaWdodD4gdGhpcy5fcExpZ2h0O1xyXG5cdFx0dmFyIGRpcjpWZWN0b3IzRCA9IGxpZ2h0LnNjZW5lRGlyZWN0aW9uO1xyXG5cdFx0dmFyIGRpclg6bnVtYmVyID0gZGlyLng7XHJcblx0XHR2YXIgZGlyWTpudW1iZXIgPSBkaXIueTtcclxuXHRcdHZhciBkaXJaOm51bWJlciA9IGRpci56O1xyXG5cdFx0dmFyIGo6bnVtYmVyID0gNDtcclxuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IDY7ICsraSkge1xyXG5cdFx0XHR2YXIgcGxhbmU6UGxhbmUzRCA9IHZpZXdGcnVzdHVtUGxhbmVzW2ldO1xyXG5cdFx0XHRpZiAocGxhbmUuYSpkaXJYICsgcGxhbmUuYipkaXJZICsgcGxhbmUuYypkaXJaIDwgMClcclxuXHRcdFx0XHR0aGlzLl9wQ3VsbFBsYW5lc1tqKytdID0gcGxhbmU7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHQvL0BvdmVycmlkZVxyXG5cdHB1YmxpYyBwVXBkYXRlRGVwdGhQcm9qZWN0aW9uKHZpZXdDYW1lcmE6Q2FtZXJhKVxyXG5cdHtcclxuXHRcdHRoaXMucFVwZGF0ZVByb2plY3Rpb25Gcm9tRnJ1c3R1bUNvcm5lcnModmlld0NhbWVyYSwgdmlld0NhbWVyYS5wcm9qZWN0aW9uLmZydXN0dW1Db3JuZXJzLCB0aGlzLl9wTWF0cml4KTtcclxuXHRcdHRoaXMuX3BPdmVyYWxsRGVwdGhQcm9qZWN0aW9uLm1hdHJpeCA9IHRoaXMuX3BNYXRyaXg7XHJcblx0XHR0aGlzLnBVcGRhdGVDdWxsUGxhbmVzKHZpZXdDYW1lcmEpO1xyXG5cdH1cclxuXHJcblx0cHVibGljIHBVcGRhdGVQcm9qZWN0aW9uRnJvbUZydXN0dW1Db3JuZXJzKHZpZXdDYW1lcmE6Q2FtZXJhLCBjb3JuZXJzOkFycmF5PG51bWJlcj4sIG1hdHJpeDpNYXRyaXgzRClcclxuXHR7XHJcblx0XHR2YXIgcmF3OkFycmF5PG51bWJlcj4gPSBuZXcgQXJyYXk8bnVtYmVyPigpO1xyXG5cdFx0dmFyIGRpcjpWZWN0b3IzRDtcclxuXHRcdHZhciB4Om51bWJlciwgeTpudW1iZXIsIHo6bnVtYmVyO1xyXG5cdFx0dmFyIG1pblg6bnVtYmVyLCBtaW5ZOm51bWJlcjtcclxuXHRcdHZhciBtYXhYOm51bWJlciwgbWF4WTpudW1iZXI7XHJcblx0XHR2YXIgaTpudW1iZXI7XHJcblxyXG5cdFx0dmFyIGxpZ2h0OkRpcmVjdGlvbmFsTGlnaHQgPSA8RGlyZWN0aW9uYWxMaWdodD4gdGhpcy5fcExpZ2h0O1xyXG5cdFx0ZGlyID0gbGlnaHQuc2NlbmVEaXJlY3Rpb247XHJcblx0XHR0aGlzLl9wT3ZlcmFsbERlcHRoQ2FtZXJhLnRyYW5zZm9ybS5tYXRyaXgzRCA9IHRoaXMuX3BMaWdodC5zY2VuZVRyYW5zZm9ybTtcclxuXHRcdHggPSBNYXRoLmZsb29yKCh2aWV3Q2FtZXJhLnggLSBkaXIueCp0aGlzLl9wTGlnaHRPZmZzZXQpL3RoaXMuX3BTbmFwKSp0aGlzLl9wU25hcDtcclxuXHRcdHkgPSBNYXRoLmZsb29yKCh2aWV3Q2FtZXJhLnkgLSBkaXIueSp0aGlzLl9wTGlnaHRPZmZzZXQpL3RoaXMuX3BTbmFwKSp0aGlzLl9wU25hcDtcclxuXHRcdHogPSBNYXRoLmZsb29yKCh2aWV3Q2FtZXJhLnogLSBkaXIueip0aGlzLl9wTGlnaHRPZmZzZXQpL3RoaXMuX3BTbmFwKSp0aGlzLl9wU25hcDtcclxuXHRcdHRoaXMuX3BPdmVyYWxsRGVwdGhDYW1lcmEueCA9IHg7XHJcblx0XHR0aGlzLl9wT3ZlcmFsbERlcHRoQ2FtZXJhLnkgPSB5O1xyXG5cdFx0dGhpcy5fcE92ZXJhbGxEZXB0aENhbWVyYS56ID0gejtcclxuXHJcblx0XHR0aGlzLl9wTWF0cml4LmNvcHlGcm9tKHRoaXMuX3BPdmVyYWxsRGVwdGhDYW1lcmEuaW52ZXJzZVNjZW5lVHJhbnNmb3JtKTtcclxuXHRcdHRoaXMuX3BNYXRyaXgucHJlcGVuZCh2aWV3Q2FtZXJhLnNjZW5lVHJhbnNmb3JtKTtcclxuXHRcdHRoaXMuX3BNYXRyaXgudHJhbnNmb3JtVmVjdG9ycyhjb3JuZXJzLCB0aGlzLl9wTG9jYWxGcnVzdHVtKTtcclxuXHJcblx0XHRtaW5YID0gbWF4WCA9IHRoaXMuX3BMb2NhbEZydXN0dW1bMF07XHJcblx0XHRtaW5ZID0gbWF4WSA9IHRoaXMuX3BMb2NhbEZydXN0dW1bMV07XHJcblx0XHR0aGlzLl9wTWF4WiA9IHRoaXMuX3BMb2NhbEZydXN0dW1bMl07XHJcblxyXG5cdFx0aSA9IDM7XHJcblx0XHR3aGlsZSAoaSA8IDI0KSB7XHJcblx0XHRcdHggPSB0aGlzLl9wTG9jYWxGcnVzdHVtW2ldO1xyXG5cdFx0XHR5ID0gdGhpcy5fcExvY2FsRnJ1c3R1bVtpICsgMV07XHJcblx0XHRcdHogPSB0aGlzLl9wTG9jYWxGcnVzdHVtW2kgKyAyXTtcclxuXHRcdFx0aWYgKHggPCBtaW5YKVxyXG5cdFx0XHRcdG1pblggPSB4O1xyXG5cdFx0XHRpZiAoeCA+IG1heFgpXHJcblx0XHRcdFx0bWF4WCA9IHg7XHJcblx0XHRcdGlmICh5IDwgbWluWSlcclxuXHRcdFx0XHRtaW5ZID0geTtcclxuXHRcdFx0aWYgKHkgPiBtYXhZKVxyXG5cdFx0XHRcdG1heFkgPSB5O1xyXG5cdFx0XHRpZiAoeiA+IHRoaXMuX3BNYXhaKVxyXG5cdFx0XHRcdHRoaXMuX3BNYXhaID0gejtcclxuXHRcdFx0aSArPSAzO1xyXG5cdFx0fVxyXG5cclxuXHRcdHRoaXMuX3BNaW5aID0gMTtcclxuXHJcblx0XHR2YXIgdzpudW1iZXIgPSBtYXhYIC0gbWluWDtcclxuXHRcdHZhciBoOm51bWJlciA9IG1heFkgLSBtaW5ZO1xyXG5cdFx0dmFyIGQ6bnVtYmVyID0gMS8odGhpcy5fcE1heFogLSB0aGlzLl9wTWluWik7XHJcblxyXG5cdFx0aWYgKG1pblggPCAwKVxyXG5cdFx0XHRtaW5YIC09IHRoaXMuX3BTbmFwOyAvLyBiZWNhdXNlIGludCgpIHJvdW5kcyB1cCBmb3IgPCAwXHJcblxyXG5cdFx0aWYgKG1pblkgPCAwKVxyXG5cdFx0XHRtaW5ZIC09IHRoaXMuX3BTbmFwO1xyXG5cclxuXHRcdG1pblggPSBNYXRoLmZsb29yKG1pblgvdGhpcy5fcFNuYXApKnRoaXMuX3BTbmFwO1xyXG5cdFx0bWluWSA9IE1hdGguZmxvb3IobWluWS90aGlzLl9wU25hcCkqdGhpcy5fcFNuYXA7XHJcblxyXG5cdFx0dmFyIHNuYXAyOm51bWJlciA9IDIqdGhpcy5fcFNuYXA7XHJcblx0XHR3ID0gTWF0aC5mbG9vcih3L3NuYXAyICsgMikqc25hcDI7XHJcblx0XHRoID0gTWF0aC5mbG9vcihoL3NuYXAyICsgMikqc25hcDI7XHJcblxyXG5cdFx0bWF4WCA9IG1pblggKyB3O1xyXG5cdFx0bWF4WSA9IG1pblkgKyBoO1xyXG5cclxuXHRcdHcgPSAxL3c7XHJcblx0XHRoID0gMS9oO1xyXG5cclxuXHRcdHJhd1swXSA9IDIqdztcclxuXHRcdHJhd1s1XSA9IDIqaDtcclxuXHRcdHJhd1sxMF0gPSBkO1xyXG5cdFx0cmF3WzEyXSA9IC0obWF4WCArIG1pblgpKnc7XHJcblx0XHRyYXdbMTNdID0gLShtYXhZICsgbWluWSkqaDtcclxuXHRcdHJhd1sxNF0gPSAtdGhpcy5fcE1pbloqZDtcclxuXHRcdHJhd1sxNV0gPSAxO1xyXG5cdFx0cmF3WzFdID0gcmF3WzJdID0gcmF3WzNdID0gcmF3WzRdID0gcmF3WzZdID0gcmF3WzddID0gcmF3WzhdID0gcmF3WzldID0gcmF3WzExXSA9IDA7XHJcblxyXG5cdFx0bWF0cml4LmNvcHlSYXdEYXRhRnJvbShyYXcpO1xyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0ID0gRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXI7Il19