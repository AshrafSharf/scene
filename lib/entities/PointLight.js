var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var BoundingSphere = require("awayjs-core/lib/bounds/BoundingSphere");
var Matrix3D = require("awayjs-core/lib/geom/Matrix3D");
var Vector3D = require("awayjs-core/lib/geom/Vector3D");
var LightBase = require("awayjs-display/lib/base/LightBase");
var PointLightNode = require("awayjs-display/lib/partition/PointLightNode");
var CubeMapShadowMapper = require("awayjs-display/lib/materials/shadowmappers/CubeMapShadowMapper");
var PointLight = (function (_super) {
    __extends(PointLight, _super);
    function PointLight() {
        _super.call(this);
        this._pRadius = 90000;
        this._pFallOff = 100000;
        this._pIsEntity = true;
        this._pFallOffFactor = 1 / (this._pFallOff * this._pFallOff - this._pRadius * this._pRadius);
    }
    PointLight.prototype.pCreateShadowMapper = function () {
        return new CubeMapShadowMapper();
    };
    Object.defineProperty(PointLight.prototype, "radius", {
        get: function () {
            return this._pRadius;
        },
        set: function (value) {
            this._pRadius = value;
            if (this._pRadius < 0) {
                this._pRadius = 0;
            }
            else if (this._pRadius > this._pFallOff) {
                this._pFallOff = this._pRadius;
                this.pInvalidateBounds();
            }
            this._pFallOffFactor = 1 / (this._pFallOff * this._pFallOff - this._pRadius * this._pRadius);
        },
        enumerable: true,
        configurable: true
    });
    PointLight.prototype.iFallOffFactor = function () {
        return this._pFallOffFactor;
    };
    Object.defineProperty(PointLight.prototype, "fallOff", {
        get: function () {
            return this._pFallOff;
        },
        set: function (value) {
            this._pFallOff = value;
            if (this._pFallOff < 0)
                this._pFallOff = 0;
            if (this._pFallOff < this._pRadius)
                this._pRadius = this._pFallOff;
            this._pFallOffFactor = 1 / (this._pFallOff * this._pFallOff - this._pRadius * this._pRadius);
            this.pInvalidateBounds();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @protected
     */
    PointLight.prototype.pCreateEntityPartitionNode = function () {
        return new PointLightNode(this);
    };
    PointLight.prototype.pUpdateBounds = function () {
        this._pBounds.fromSphere(new Vector3D(), this._pFallOff);
        this._pBoundsInvalid = false;
    };
    PointLight.prototype.pCreateDefaultBoundingVolume = function () {
        //point lights are culled based on their falloff radius
        return new BoundingSphere();
    };
    PointLight.prototype.iGetObjectProjectionMatrix = function (entity, camera, target) {
        if (target === void 0) { target = null; }
        var raw = new Array(16);
        var bounds = entity.bounds;
        var m = new Matrix3D();
        // todo: do not use lookAt on Light
        m.copyFrom(entity.getRenderSceneTransform(camera));
        m.append(this._pParent.inverseSceneTransform);
        this.lookAt(m.position);
        m.copyFrom(entity.getRenderSceneTransform(camera));
        m.append(this.inverseSceneTransform);
        var box = bounds.aabb;
        var v1 = m.deltaTransformVector(new Vector3D(box.left, box.bottom, box.front));
        var v2 = m.deltaTransformVector(new Vector3D(box.right, box.top, box.back));
        var d1 = v1.x * v1.x + v1.y * v1.y + v1.z * v1.z;
        var d2 = v2.x * v2.x + v2.y * v2.y + v2.z * v2.z;
        var d = Math.sqrt(d1 > d2 ? d1 : d2);
        var zMin;
        var zMax;
        var z = m.rawData[14];
        zMin = z - d;
        zMax = z + d;
        raw[5] = raw[0] = zMin / d;
        raw[10] = zMax / (zMax - zMin);
        raw[11] = 1;
        raw[1] = raw[2] = raw[3] = raw[4] = raw[6] = raw[7] = raw[8] = raw[9] = raw[12] = raw[13] = raw[15] = 0;
        raw[14] = -zMin * raw[10];
        if (!target)
            target = new Matrix3D();
        target.copyRawDataFrom(raw);
        target.prepend(m);
        return target;
    };
    PointLight.prototype._iCollectRenderables = function (renderer) {
        //nothing to do here
    };
    return PointLight;
})(LightBase);
module.exports = PointLight;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9wb2ludGxpZ2h0LnRzIl0sIm5hbWVzIjpbIlBvaW50TGlnaHQiLCJQb2ludExpZ2h0LmNvbnN0cnVjdG9yIiwiUG9pbnRMaWdodC5wQ3JlYXRlU2hhZG93TWFwcGVyIiwiUG9pbnRMaWdodC5yYWRpdXMiLCJQb2ludExpZ2h0LmlGYWxsT2ZmRmFjdG9yIiwiUG9pbnRMaWdodC5mYWxsT2ZmIiwiUG9pbnRMaWdodC5wQ3JlYXRlRW50aXR5UGFydGl0aW9uTm9kZSIsIlBvaW50TGlnaHQucFVwZGF0ZUJvdW5kcyIsIlBvaW50TGlnaHQucENyZWF0ZURlZmF1bHRCb3VuZGluZ1ZvbHVtZSIsIlBvaW50TGlnaHQuaUdldE9iamVjdFByb2plY3Rpb25NYXRyaXgiLCJQb2ludExpZ2h0Ll9pQ29sbGVjdFJlbmRlcmFibGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFPLGNBQWMsV0FBYyx1Q0FBdUMsQ0FBQyxDQUFDO0FBRzVFLElBQU8sUUFBUSxXQUFnQiwrQkFBK0IsQ0FBQyxDQUFDO0FBQ2hFLElBQU8sUUFBUSxXQUFnQiwrQkFBK0IsQ0FBQyxDQUFDO0FBRWhFLElBQU8sU0FBUyxXQUFlLG1DQUFtQyxDQUFDLENBQUM7QUFFcEUsSUFBTyxjQUFjLFdBQWMsNkNBQTZDLENBQUMsQ0FBQztBQUlsRixJQUFPLG1CQUFtQixXQUFhLGdFQUFnRSxDQUFDLENBQUM7QUFFekcsSUFBTSxVQUFVO0lBQVNBLFVBQW5CQSxVQUFVQSxVQUFrQkE7SUFNakNBLFNBTktBLFVBQVVBO1FBUWRDLGlCQUFPQSxDQUFDQTtRQU5GQSxhQUFRQSxHQUFVQSxLQUFLQSxDQUFDQTtRQUN4QkEsY0FBU0EsR0FBVUEsTUFBTUEsQ0FBQ0E7UUFPaENBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBO1FBRXZCQSxJQUFJQSxDQUFDQSxlQUFlQSxHQUFHQSxDQUFDQSxHQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFT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LElBQUlBLEVBQUVBLEdBQVlBLENBQUNBLENBQUNBLG9CQUFvQkEsQ0FBQ0EsSUFBSUEsUUFBUUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsS0FBS0EsRUFBRUEsR0FBR0EsQ0FBQ0EsR0FBR0EsRUFBRUEsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDckZBLElBQUlBLEVBQUVBLEdBQVVBLEVBQUVBLENBQUNBLENBQUNBLEdBQUNBLEVBQUVBLENBQUNBLENBQUNBLEdBQUdBLEVBQUVBLENBQUNBLENBQUNBLEdBQUNBLEVBQUVBLENBQUNBLENBQUNBLEdBQUdBLEVBQUVBLENBQUNBLENBQUNBLEdBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQ2xEQSxJQUFJQSxFQUFFQSxHQUFVQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNsREEsSUFBSUEsQ0FBQ0EsR0FBVUEsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsR0FBR0EsRUFBRUEsR0FBRUEsRUFBRUEsR0FBR0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDM0NBLElBQUlBLElBQVdBLENBQUNBO1FBQ2hCQSxJQUFJQSxJQUFXQSxDQUFDQTtRQUVoQkEsSUFBSUEsQ0FBQ0EsR0FBVUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDN0JBLElBQUlBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQ2JBLElBQUlBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBRWJBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLEdBQUNBLENBQUNBLENBQUNBO1FBQ3pCQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxJQUFJQSxHQUFDQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUM3QkEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDWkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDeEdBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLEdBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBO1FBRXhCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQTtZQUNYQSxNQUFNQSxHQUFHQSxJQUFJQSxRQUFRQSxFQUFFQSxDQUFDQTtRQUV6QkEsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDNUJBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBRWxCQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQTtJQUNmQSxDQUFDQTtJQUVNVCx5Q0FBb0JBLEdBQTNCQSxVQUE0QkEsUUFBa0JBO1FBRTdDVSxvQkFBb0JBO0lBQ3JCQSxDQUFDQTtJQUNGVixpQkFBQ0E7QUFBREEsQ0FoSUEsQUFnSUNBLEVBaEl3QixTQUFTLEVBZ0lqQztBQUVELEFBQW9CLGlCQUFYLFVBQVUsQ0FBQyIsImZpbGUiOiJlbnRpdGllcy9Qb2ludExpZ2h0LmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCb3VuZGluZ1NwaGVyZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2JvdW5kcy9Cb3VuZGluZ1NwaGVyZVwiKTtcbmltcG9ydCBCb3VuZGluZ1ZvbHVtZUJhc2VcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvYm91bmRzL0JvdW5kaW5nVm9sdW1lQmFzZVwiKTtcbmltcG9ydCBCb3hcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL0JveFwiKTtcbmltcG9ydCBNYXRyaXgzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL01hdHJpeDNEXCIpO1xuaW1wb3J0IFZlY3RvcjNEXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vVmVjdG9yM0RcIik7XG5cbmltcG9ydCBMaWdodEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvTGlnaHRCYXNlXCIpO1xuaW1wb3J0IEVudGl0eU5vZGVcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL3BhcnRpdGlvbi9FbnRpdHlOb2RlXCIpO1xuaW1wb3J0IFBvaW50TGlnaHROb2RlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvcGFydGl0aW9uL1BvaW50TGlnaHROb2RlXCIpO1xuaW1wb3J0IElSZW5kZXJlclx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvcmVuZGVyL0lSZW5kZXJlclwiKTtcbmltcG9ydCBDYW1lcmFcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xuaW1wb3J0IElFbnRpdHlcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvSUVudGl0eVwiKTtcbmltcG9ydCBDdWJlTWFwU2hhZG93TWFwcGVyXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL21hdGVyaWFscy9zaGFkb3dtYXBwZXJzL0N1YmVNYXBTaGFkb3dNYXBwZXJcIik7XG5cbmNsYXNzIFBvaW50TGlnaHQgZXh0ZW5kcyBMaWdodEJhc2UgaW1wbGVtZW50cyBJRW50aXR5XG57XG5cdHB1YmxpYyBfcFJhZGl1czpudW1iZXIgPSA5MDAwMDtcblx0cHVibGljIF9wRmFsbE9mZjpudW1iZXIgPSAxMDAwMDA7XG5cdHB1YmxpYyBfcEZhbGxPZmZGYWN0b3I6bnVtYmVyO1xuXG5cdGNvbnN0cnVjdG9yKClcblx0e1xuXHRcdHN1cGVyKCk7XG5cblx0XHR0aGlzLl9wSXNFbnRpdHkgPSB0cnVlO1xuXG5cdFx0dGhpcy5fcEZhbGxPZmZGYWN0b3IgPSAxLyh0aGlzLl9wRmFsbE9mZip0aGlzLl9wRmFsbE9mZiAtIHRoaXMuX3BSYWRpdXMqdGhpcy5fcFJhZGl1cyk7XG5cdH1cblxuXHRwdWJsaWMgcENyZWF0ZVNoYWRvd01hcHBlcigpOkN1YmVNYXBTaGFkb3dNYXBwZXJcblx0e1xuXHRcdHJldHVybiBuZXcgQ3ViZU1hcFNoYWRvd01hcHBlcigpO1xuXHR9XG5cblx0cHVibGljIGdldCByYWRpdXMoKTpudW1iZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9wUmFkaXVzO1xuXHR9XG5cblx0cHVibGljIHNldCByYWRpdXModmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fcFJhZGl1cyA9IHZhbHVlO1xuXG5cdFx0aWYgKHRoaXMuX3BSYWRpdXMgPCAwKSB7XG5cdFx0XHR0aGlzLl9wUmFkaXVzID0gMDtcblx0XHR9IGVsc2UgaWYgKHRoaXMuX3BSYWRpdXMgPiB0aGlzLl9wRmFsbE9mZikge1xuXHRcdFx0dGhpcy5fcEZhbGxPZmYgPSB0aGlzLl9wUmFkaXVzO1xuXHRcdFx0dGhpcy5wSW52YWxpZGF0ZUJvdW5kcygpO1xuXHRcdH1cblx0XHR0aGlzLl9wRmFsbE9mZkZhY3RvciA9IDEvKCB0aGlzLl9wRmFsbE9mZip0aGlzLl9wRmFsbE9mZiAtIHRoaXMuX3BSYWRpdXMqdGhpcy5fcFJhZGl1cyApO1xuXHR9XG5cblx0cHVibGljIGlGYWxsT2ZmRmFjdG9yKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fcEZhbGxPZmZGYWN0b3I7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IGZhbGxPZmYoKTpudW1iZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9wRmFsbE9mZjtcblx0fVxuXG5cdHB1YmxpYyBzZXQgZmFsbE9mZih2YWx1ZTpudW1iZXIpXG5cdHtcblx0XHR0aGlzLl9wRmFsbE9mZiA9IHZhbHVlO1xuXG5cdFx0aWYgKHRoaXMuX3BGYWxsT2ZmIDwgMClcblx0XHRcdHRoaXMuX3BGYWxsT2ZmID0gMDtcblxuXHRcdGlmICh0aGlzLl9wRmFsbE9mZiA8IHRoaXMuX3BSYWRpdXMpXG5cdFx0XHR0aGlzLl9wUmFkaXVzID0gdGhpcy5fcEZhbGxPZmY7XG5cblx0XHR0aGlzLl9wRmFsbE9mZkZhY3RvciA9IDEvKCB0aGlzLl9wRmFsbE9mZip0aGlzLl9wRmFsbE9mZiAtIHRoaXMuX3BSYWRpdXMqdGhpcy5fcFJhZGl1cyk7XG5cdFx0dGhpcy5wSW52YWxpZGF0ZUJvdW5kcygpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBwcm90ZWN0ZWRcblx0ICovXG5cdHB1YmxpYyBwQ3JlYXRlRW50aXR5UGFydGl0aW9uTm9kZSgpOkVudGl0eU5vZGVcblx0e1xuXHRcdHJldHVybiBuZXcgUG9pbnRMaWdodE5vZGUodGhpcyk7XG5cdH1cblxuXHRwdWJsaWMgcFVwZGF0ZUJvdW5kcygpXG5cdHtcblx0XHR0aGlzLl9wQm91bmRzLmZyb21TcGhlcmUobmV3IFZlY3RvcjNEKCksIHRoaXMuX3BGYWxsT2ZmKTtcblx0XHR0aGlzLl9wQm91bmRzSW52YWxpZCA9IGZhbHNlO1xuXHR9XG5cblx0cHVibGljIHBDcmVhdGVEZWZhdWx0Qm91bmRpbmdWb2x1bWUoKTpCb3VuZGluZ1ZvbHVtZUJhc2Vcblx0e1xuXHRcdC8vcG9pbnQgbGlnaHRzIGFyZSBjdWxsZWQgYmFzZWQgb24gdGhlaXIgZmFsbG9mZiByYWRpdXNcblx0XHRyZXR1cm4gbmV3IEJvdW5kaW5nU3BoZXJlKCk7XG5cdH1cblxuXHRwdWJsaWMgaUdldE9iamVjdFByb2plY3Rpb25NYXRyaXgoZW50aXR5OklFbnRpdHksIGNhbWVyYTpDYW1lcmEsIHRhcmdldDpNYXRyaXgzRCA9IG51bGwpOk1hdHJpeDNEXG5cdHtcblx0XHR2YXIgcmF3Om51bWJlcltdID0gbmV3IEFycmF5PG51bWJlcj4oMTYpO1xuXHRcdHZhciBib3VuZHM6Qm91bmRpbmdWb2x1bWVCYXNlID0gZW50aXR5LmJvdW5kcztcblx0XHR2YXIgbTpNYXRyaXgzRCA9IG5ldyBNYXRyaXgzRCgpO1xuXG5cdFx0Ly8gdG9kbzogZG8gbm90IHVzZSBsb29rQXQgb24gTGlnaHRcblx0XHRtLmNvcHlGcm9tKGVudGl0eS5nZXRSZW5kZXJTY2VuZVRyYW5zZm9ybShjYW1lcmEpKTtcblx0XHRtLmFwcGVuZCh0aGlzLl9wUGFyZW50LmludmVyc2VTY2VuZVRyYW5zZm9ybSk7XG5cdFx0dGhpcy5sb29rQXQobS5wb3NpdGlvbik7XG5cblx0XHRtLmNvcHlGcm9tKGVudGl0eS5nZXRSZW5kZXJTY2VuZVRyYW5zZm9ybShjYW1lcmEpKTtcblx0XHRtLmFwcGVuZCh0aGlzLmludmVyc2VTY2VuZVRyYW5zZm9ybSk7XG5cblx0XHR2YXIgYm94OkJveCA9IGJvdW5kcy5hYWJiO1xuXHRcdHZhciB2MTpWZWN0b3IzRCA9IG0uZGVsdGFUcmFuc2Zvcm1WZWN0b3IobmV3IFZlY3RvcjNEKGJveC5sZWZ0LCBib3guYm90dG9tLCBib3guZnJvbnQpKTtcblx0XHR2YXIgdjI6VmVjdG9yM0QgPSBtLmRlbHRhVHJhbnNmb3JtVmVjdG9yKG5ldyBWZWN0b3IzRChib3gucmlnaHQsIGJveC50b3AsIGJveC5iYWNrKSk7XG5cdFx0dmFyIGQxOm51bWJlciA9IHYxLngqdjEueCArIHYxLnkqdjEueSArIHYxLnoqdjEuejtcblx0XHR2YXIgZDI6bnVtYmVyID0gdjIueCp2Mi54ICsgdjIueSp2Mi55ICsgdjIueip2Mi56O1xuXHRcdHZhciBkOm51bWJlciA9IE1hdGguc3FydChkMSA+IGQyPyBkMSA6IGQyKTtcblx0XHR2YXIgek1pbjpudW1iZXI7XG5cdFx0dmFyIHpNYXg6bnVtYmVyO1xuXG5cdFx0dmFyIHo6bnVtYmVyID0gbS5yYXdEYXRhWzE0XTtcblx0XHR6TWluID0geiAtIGQ7XG5cdFx0ek1heCA9IHogKyBkO1xuXG5cdFx0cmF3WzVdID0gcmF3WzBdID0gek1pbi9kO1xuXHRcdHJhd1sxMF0gPSB6TWF4Lyh6TWF4IC0gek1pbik7XG5cdFx0cmF3WzExXSA9IDE7XG5cdFx0cmF3WzFdID0gcmF3WzJdID0gcmF3WzNdID0gcmF3WzRdID0gcmF3WzZdID0gcmF3WzddID0gcmF3WzhdID0gcmF3WzldID0gcmF3WzEyXSA9IHJhd1sxM10gPSByYXdbMTVdID0gMDtcblx0XHRyYXdbMTRdID0gLXpNaW4qcmF3WzEwXTtcblxuXHRcdGlmICghdGFyZ2V0KVxuXHRcdFx0dGFyZ2V0ID0gbmV3IE1hdHJpeDNEKCk7XG5cblx0XHR0YXJnZXQuY29weVJhd0RhdGFGcm9tKHJhdyk7XG5cdFx0dGFyZ2V0LnByZXBlbmQobSk7XG5cblx0XHRyZXR1cm4gdGFyZ2V0O1xuXHR9XG5cblx0cHVibGljIF9pQ29sbGVjdFJlbmRlcmFibGVzKHJlbmRlcmVyOklSZW5kZXJlcilcblx0e1xuXHRcdC8vbm90aGluZyB0byBkbyBoZXJlXG5cdH1cbn1cblxuZXhwb3J0ID0gUG9pbnRMaWdodDsiXX0=